{"version":3,"file":"Login-961roo0b.js","sources":["../../src/pages/auth/Login.tsx"],"sourcesContent":["import React, { useEffect, useMemo, useState } from \"react\";\n\nconst AUTH_BASE = \"/.netlify/functions/auth-session\";\nconst LOGIN_URL = `${AUTH_BASE}?action=login`;\nconst ME_URL    = `${AUTH_BASE}?action=me`;   // usaremos GET com ?email=...\n\nconst RESET_URL = \"/.netlify/functions/reset-dispatch\";\n\ntype ApiResp = {\n  ok?: boolean;\n  error?: string;\n  message?: string;\n  user?: { email: string; role: \"admin\" | \"client\"; siteSlug?: string };\n};\n\nexport default function LoginPage() {\n  const [email, setEmail] = useState(\"\");\n  const [pass,  setPass]  = useState(\"\");\n  const [loading, setLoading] = useState(false);\n  const [msg, setMsg]   = useState<string | null>(null);\n  const [err, setErr]   = useState<string | null>(null);\n\n  const [forgotOpen, setForgotOpen]   = useState(false);\n  const [forgotEmail, setForgotEmail] = useState(\"\");\n  const [forgotLoading, setForgotLoading] = useState(false);\n\n  const next = useMemo(() => {\n    try {\n      const p = new URLSearchParams(window.location.search);\n      const n = p.get(\"next\") || \"\";\n      return n.startsWith(\"/\") ? n : \"\";\n    } catch { return \"\"; }\n  }, []);\n\n  useEffect(() => {\n    (async () => {\n      try {\n        // Se você tiver o e-mail salvo em localStorage, dá pra passar aqui.\n        const current = window.localStorage.getItem(\"elevea_last_email\") || \"\";\n        if (!current) return;\n\n        const r = await fetch(`${ME_URL}&email=${encodeURIComponent(current)}`, {\n          method: \"GET\",\n          cache: \"no-store\",\n        });\n        const data: ApiResp = await r.json().catch(() => ({} as any));\n        if (data?.ok && data.user) redirectByRole(data.user.role, next);\n      } catch {/* ignore */}\n    })();\n  }, [next]);\n\n  function redirectByRole(role: \"admin\" | \"client\", candidate?: string) {\n    if (candidate) {\n      if (role === \"admin\"  && candidate.startsWith(\"/admin/\"))  return void window.location.assign(candidate);\n      if (role === \"client\" && candidate.startsWith(\"/client/\")) return void window.location.assign(candidate);\n    }\n    window.location.assign(role === \"admin\" ? \"/admin/dashboard\" : \"/client/dashboard\");\n  }\n\n  async function doLogin(e: React.FormEvent<HTMLFormElement>) {\n    e.preventDefault();\n    setErr(null); setMsg(null); setLoading(true);\n\n    try {\n      const emailLc = email.trim().toLowerCase();\n\n      const r = await fetch(LOGIN_URL, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        // Enviamos o action também no body como fallback\n        body: JSON.stringify({ action: \"login\", email: emailLc, password: pass }),\n      });\n\n      if (r.status >= 500) {\n        const txt = await r.text().catch(() => \"\");\n        setErr(`Servidor indisponível (${r.status}). ${txt || \"\"}`.trim());\n        return;\n      }\n\n      const data: ApiResp = await r.json().catch(() => ({} as any));\n      if (!r.ok || data.ok === false) {\n        setErr(data.error || data.message || `Falha no login (${r.status})`);\n        return;\n      }\n      if (!data.user?.role) {\n        setErr(\"Resposta inválida do servidor.\");\n        return;\n      }\n\n      // guarda último e-mail para o “me”\n      try { window.localStorage.setItem(\"elevea_last_email\", emailLc); } catch {}\n\n      redirectByRole(data.user.role, next);\n    } catch (e: any) {\n      setErr(e?.message || \"Erro de rede\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function handleSendReset(emailIn: string): Promise<{ ok: boolean; error?: string }> {\n    try {\n      const email = emailIn.trim().toLowerCase();\n      if (!email || !/^\\S+@\\S+\\.\\S+$/.test(email)) return { ok:false, error:\"email_invalido\" };\n\n      setForgotLoading(true);\n      const r = await fetch(RESET_URL, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ email }),\n      });\n      const data: ApiResp = await r.json().catch(() => ({} as any));\n      setForgotLoading(false);\n\n      if (!r.ok || data?.ok === false) return { ok:false, error: data?.error || data?.message || `http_${r.status}` };\n      return { ok:true };\n    } catch (e: any) {\n      setForgotLoading(false);\n      return { ok:false, error:String(e?.message || e) };\n    }\n  }\n\n  async function doForgot(e: React.FormEvent<HTMLFormElement>) {\n    e.preventDefault();\n    setErr(null); setMsg(null);\n    const res = await handleSendReset(forgotEmail);\n    if (!res.ok) { setErr(res.error || \"Falha ao enviar o link\"); return; }\n    setMsg(\"Se o e-mail existir, enviamos um link de redefinição.\");\n    setForgotOpen(false);\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-100 flex items-center justify-center p-6\">\n      <div className=\"w-full max-w-md bg-white rounded-2xl shadow p-8\">\n        <h1 className=\"text-2xl font-bold mb-6\">Entrar</h1>\n\n        <form className=\"space-y-4\" onSubmit={doLogin}>\n          <input\n            type=\"email\"\n            placeholder=\"E-mail\"\n            value={email}\n            onChange={(e)=>setEmail(e.target.value)}\n            className=\"w-full border rounded-xl px-4 py-3\"\n            autoComplete=\"username\"\n            required\n          />\n          <input\n            type=\"password\"\n            placeholder=\"Senha\"\n            value={pass}\n            onChange={(e)=>setPass(e.target.value)}\n            className=\"w-full border rounded-xl px-4 py-3\"\n            autoComplete=\"current-password\"\n            required\n          />\n          <button\n            type=\"submit\"\n            disabled={loading}\n            className=\"w-full bg-black text-white rounded-xl py-3 hover:bg-gray-800\"\n          >\n            {loading ? \"Entrando...\" : \"Entrar\"}\n          </button>\n        </form>\n\n        <div className=\"mt-4 text-sm\">\n          <button className=\"text-blue-600 underline\" onClick={()=>setForgotOpen(true)}>\n            Esqueci a senha\n          </button>\n        </div>\n\n        {err && <div className=\"mt-4 text-red-600 whitespace-pre-wrap\">{err}</div>}\n        {msg && <div className=\"mt-4 text-green-600 break-words\">{msg}</div>}\n      </div>\n\n      {forgotOpen && (\n        <div className=\"fixed inset-0 bg-black/40 flex items-center justify-center\">\n          <div className=\"bg-white w-full max-w-md rounded-xl shadow p-6\">\n            <h2 className=\"text-xl font-semibold mb-4\">Reset de Senha</h2>\n            <form className=\"space-y-4\" onSubmit={doForgot}>\n              <input\n                type=\"email\"\n                placeholder=\"E-mail\"\n                value={forgotEmail}\n                onChange={(e)=>setForgotEmail(e.target.value)}\n                className=\"w-full border rounded-xl px-4 py-3\"\n                required\n              />\n              <div className=\"flex gap-2\">\n                <button type=\"submit\" className=\"bg-black text-white rounded-xl px-4 py-2\" disabled={forgotLoading}>\n                  {forgotLoading ? \"Enviando...\" : \"Enviar link\"}\n                </button>\n                <button type=\"button\" className=\"border rounded-xl px-4 py-2\" onClick={()=>setForgotOpen(false)}>\n                  Fechar\n                </button>\n              </div>\n            </form>\n            <p className=\"text-xs text-gray-500 mt-3\">Você receberá um link para criar uma nova senha.</p>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n"],"names":["AUTH_BASE","LOGIN_URL","ME_URL","RESET_URL","LoginPage","email","setEmail","useState","pass","setPass","loading","setLoading","msg","setMsg","err","setErr","forgotOpen","setForgotOpen","forgotEmail","setForgotEmail","forgotLoading","setForgotLoading","next","useMemo","n","useEffect","current","data","redirectByRole","role","candidate","doLogin","e","emailLc","r","txt","_a","handleSendReset","emailIn","doForgot","res","jsxs","jsx"],"mappings":"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"}