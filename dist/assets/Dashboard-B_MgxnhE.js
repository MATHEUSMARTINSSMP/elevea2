import{r as m,j as e,R as W}from"./index-C2aJ28FA.js";import{T as D}from"./loading-skeletons-CHf1Nwx-.js";var k={};const X="/.netlify/functions/sheets-proxy",Y="/.netlify/functions/admin-toggle";function y(...n){return n.filter(Boolean).join(" ")}function Z({children:n,tone:i="neutral"}){const l={neutral:"bg-gray-100 text-gray-700 border border-gray-200",green:"bg-emerald-100 text-emerald-700 border border-emerald-200",red:"bg-rose-100 text-rose-700 border border-rose-200",amber:"bg-amber-100 text-amber-800 border border-amber-200"};return e.jsxs("span",{className:y("px-2.5 py-1 rounded-full text-xs font-medium inline-flex items-center gap-1",l[i]),children:[e.jsx("span",{className:"h-1.5 w-1.5 rounded-full bg-current opacity-80"}),n]})}function _(n){const{className:i,variant:l="solid",...h}=n,x="inline-flex items-center justify-center rounded-xl text-sm px-3.5 py-2.5 transition shadow-sm disabled:opacity-60 disabled:cursor-not-allowed",p={solid:"bg-black text-white hover:bg-gray-900",outline:"border border-gray-300 bg-white hover:bg-gray-50",ghost:"hover:bg-gray-100 text-gray-800"};return e.jsx("button",{className:y(x,p[l],i),...h})}function C({name:n,className:i=""}){const l={refresh:"M4 4v4m0-4h4M4 8l4-4m8 12v-4m0 4h-4m4-4-4 4M4 16h4m8-8h4",lock:"M6 10V8a4 4 0 1 1 8 0v2m-9 0h10v6a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-6z",unlock:"M15 10V8a4 4 0 0 0-8 0m-1 2h10v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-6z",download:"M12 3v10m0 0 3-3m-3 3-3-3M5 17h14",search:"M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16zm11 3-6-6"};return e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.8",className:y("h-4 w-4",i),children:e.jsx("path",{d:l[n],strokeLinecap:"round",strokeLinejoin:"round"})})}function O(n){if(!n)return"—";try{return new Date(n).toLocaleString("pt-BR")}catch{return String(n)}}function ee(n,i){if(!i||!i.length)return;const l=Object.keys(i[0]),h=[l.join(","),...i.map(o=>l.map(f=>JSON.stringify(o[f]??"")).join(","))].join(`
`),x=new Blob([h],{type:"text/csv;charset=utf-8;"}),p=URL.createObjectURL(x),u=document.createElement("a");u.href=p,u.download=n,u.click(),URL.revokeObjectURL(p)}function se(n,i=250){const[l,h]=m.useState(n);return m.useEffect(()=>{const x=setTimeout(()=>h(n),i);return()=>clearTimeout(x)},[n,i]),l}function ce(){const[n,i]=m.useState(!1),[l,h]=m.useState([]),[x,p]=m.useState(""),u=se(x,250),[o,f]=m.useState("all"),[T,b]=m.useState(""),[c,g]=m.useState(""),[S,q]=m.useState({}),[H,J]=m.useState({}),[V,z]=m.useState({}),[K,Q]=m.useState({}),[A,I]=m.useState(""),[F,R]=m.useState(null);function P(t,s){R({type:t,msg:s}),setTimeout(()=>R(null),3200)}async function $(){i(!0),b("");try{const t=await fetch(`/.netlify/functions/admin-sites?nc=${Date.now()}`,{cache:"no-store"});if(!t.ok)throw new Error(`Falha ao listar sites (HTTP ${t.status})`);const s=await t.json(),a=((s==null?void 0:s.siteSlugs)||[]).filter(Boolean),d=await Promise.all(a.map(async r=>{try{const j=await fetch(`${X}?type=status&site=${encodeURIComponent(r)}&nc=${Date.now()}`,{cache:"no-store"});if(!j.ok)throw new Error(`Falha status ${r} (HTTP ${j.status})`);const w=await j.json();return{siteSlug:r,status:w}}catch(j){return console.error(j),{siteSlug:r,status:null}}}));h(d)}catch(t){b((t==null?void 0:t.message)||"Erro ao carregar dados."),h([])}finally{i(!1)}}m.useEffect(()=>{$()},[]);const M=m.useMemo(()=>{const t=u.trim().toUpperCase();return l.filter(s=>{const a=s.status,d=!t||s.siteSlug.toUpperCase().includes(t)||((a==null?void 0:a.email)||"").toUpperCase().includes(t)||((a==null?void 0:a.preapproval_id)||"").toUpperCase().includes(t);let r=!0;return o==="active"&&(r=!!(a!=null&&a.ok&&(a!=null&&a.active)&&!(a!=null&&a.manualBlock))),o==="blocked"&&(r=!!(a!=null&&a.manualBlock)),o==="inactive"&&(r=!!(a!=null&&a.ok&&!(a!=null&&a.active))),d&&r})},[l,u,o]),E=m.useMemo(()=>{const t=l.length,s=l.filter(r=>{var j,w,U;return((j=r.status)==null?void 0:j.ok)&&((w=r.status)==null?void 0:w.active)&&!((U=r.status)!=null&&U.manualBlock)}).length,a=l.filter(r=>{var j;return(j=r.status)==null?void 0:j.manualBlock}).length,d=l.filter(r=>{var j,w;return((j=r.status)==null?void 0:j.ok)&&!((w=r.status)!=null&&w.active)}).length;return{total:t,active:s,blocked:a,inactive:d}},[l]);async function L(t,s){try{I(t);const a=await fetch(Y,{method:"POST",headers:{"Content-Type":"application/json","x-elevea-internal":"1"},body:JSON.stringify({action:"manual-block",siteSlug:t,block:!!s})});if(!a.ok){const d=await a.text().catch(()=>"");throw new Error(`HTTP ${a.status} - ${d||"admin-toggle falhou"}`)}P("ok",s?"Site bloqueado":"Site reativado"),await $()}catch(a){console.error(a),P("err",(a==null?void 0:a.message)||"Falha ao alternar bloqueio."),alert((a==null?void 0:a.message)||"Falha ao alternar bloqueio.")}finally{I("")}}async function G(t,s){if(g(a=>a===t?"":t),!(c&&c===t))try{if(s){const d=await(await fetch(`/.netlify/functions/client-billing?email=${encodeURIComponent(s)}`,{cache:"no-store"})).json();q(r=>({...r,[t]:d}))}{const d=await(await fetch(`/.netlify/functions/client-api?action=list_leads&site=${encodeURIComponent(t)}&page=1&size=100&nc=${Date.now()}`,{cache:"no-store"})).json();J(r=>({...r,[t]:(d==null?void 0:d.items)||[]}))}{const d=await(await fetch(`/.netlify/functions/client-api?action=list_feedbacks&site=${encodeURIComponent(t)}&page=1&size=100&nc=${Date.now()}`,{cache:"no-store"})).json();z(r=>({...r,[t]:(d==null?void 0:d.items)||[]}))}{const d=await(await fetch(`/.netlify/functions/client-api?action=get_traffic&site=${encodeURIComponent(t)}&range=30d&nc=${Date.now()}`,{cache:"no-store"})).json();Q(r=>({...r,[t]:(d==null?void 0:d.daily)||[]}))}}catch(a){console.error(a),P("err","Alguns relatórios não puderam ser carregados.")}}return e.jsxs("div",{className:"min-h-screen bg-gradient-to-b from-slate-50 to-slate-100/60 py-10 px-5 md:px-8",children:[e.jsxs("div",{className:"mx-auto max-w-7xl space-y-8",children:[e.jsxs("div",{className:"flex flex-col gap-4 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-semibold tracking-tight",children:"Painel Elevea · Assinaturas"}),e.jsx("p",{className:"text-slate-600 mt-1",children:"Status, bloqueios e relatórios (financeiro, leads, feedbacks, tráfego)."})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(_,{variant:"outline",onClick:$,disabled:n,children:[e.jsx(C,{name:"refresh",className:y(n&&"animate-spin")})," ",e.jsx("span",{className:"ml-2",children:n?"Atualizando":"Atualizar"})]})})]}),!!T&&e.jsxs("div",{className:"rounded-xl border bg-white p-3 text-sm text-rose-700",children:[e.jsx("div",{className:"font-medium",children:"Erro"}),e.jsx("div",{className:"opacity-80",children:T})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(B,{title:"Total",value:E.total}),e.jsx(B,{title:"Ativos",value:E.active}),e.jsx(B,{title:"Bloqueados",value:E.blocked}),e.jsx(B,{title:"Inativos",value:E.inactive})]}),e.jsxs("div",{className:"flex flex-col md:flex-row items-stretch md:items-center gap-3",children:[e.jsxs("div",{className:"relative w-full md:w-[28rem]",children:[e.jsx(C,{name:"search",className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"}),e.jsx("input",{className:"w-full border rounded-xl pl-9 pr-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-black/70",placeholder:"Buscar por site, e-mail ou preapproval_id...",value:x,onChange:t=>p(t.target.value)})]}),e.jsx("div",{className:"flex gap-2",children:["all","active","blocked","inactive"].map(t=>e.jsx(_,{variant:o===t?"solid":"outline",onClick:()=>f(t),children:t},t))})]}),e.jsx("div",{className:"overflow-x-auto rounded-2xl border bg-white shadow-sm",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-slate-50 text-slate-600 sticky top-0",children:e.jsxs("tr",{children:[e.jsx(v,{children:"Site"}),e.jsx(v,{children:"Status"}),e.jsx(v,{children:"Pagamento"}),e.jsx(v,{children:"E-mail"}),e.jsx(v,{children:"Preapproval"}),e.jsx(v,{children:"Atualizado"}),e.jsx(v,{className:"text-center",children:"Bloq. manual"}),e.jsx(v,{className:"text-right",children:"Ações"})]})}),e.jsxs("tbody",{children:[M.map(t=>{const s=t.status,a=s!=null&&s.ok?s!=null&&s.manualBlock?"red":s!=null&&s.active?"green":"neutral":"amber",d=s!=null&&s.ok?s!=null&&s.manualBlock?"bloqueado":s!=null&&s.active?"ativo":"inativo":"erro";return e.jsxs(W.Fragment,{children:[e.jsxs("tr",{className:"border-t hover:bg-slate-50/70",children:[e.jsx(N,{className:"font-medium",children:t.siteSlug}),e.jsx(N,{children:e.jsx(Z,{tone:a,children:d})}),e.jsx(N,{children:(s==null?void 0:s.status)||"—"}),e.jsx(N,{className:"max-w-[16rem] truncate",children:(s==null?void 0:s.email)||"—"}),e.jsx(N,{className:"max-w-[12rem] truncate",children:(s==null?void 0:s.preapproval_id)||"—"}),e.jsx(N,{children:O(s==null?void 0:s.updatedAt)}),e.jsx(N,{className:"text-center",children:e.jsx("input",{type:"checkbox",className:"h-4 w-4 accent-black",checked:!!(s!=null&&s.manualBlock),onChange:r=>L(t.siteSlug,r.target.checked),disabled:A===t.siteSlug,"aria-label":`Bloqueio manual de ${t.siteSlug}`})}),e.jsxs(N,{className:"text-right space-x-2 whitespace-nowrap",children:[e.jsx(_,{variant:"outline",onClick:()=>G(t.siteSlug,s==null?void 0:s.email),children:"Relatórios"}),e.jsx(_,{onClick:()=>L(t.siteSlug,!(s!=null&&s.manualBlock)),disabled:A===t.siteSlug,className:y(s!=null&&s.manualBlock?"bg-emerald-600 hover:bg-emerald-700":"bg-black hover:bg-gray-900","text-white"),children:s!=null&&s.manualBlock?e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx(C,{name:"unlock"})," Reativar"]}):e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx(C,{name:"lock"})," Bloquear"]})})]})]}),c===t.siteSlug&&e.jsx("tr",{className:"bg-slate-50/60",children:e.jsx("td",{colSpan:8,className:"px-4 py-6",children:e.jsx(te,{slug:t.siteSlug,email:s==null?void 0:s.email,billing:S[t.siteSlug]??null,leads:H[t.siteSlug]??[],feedbacks:V[t.siteSlug]??[],traffic:K[t.siteSlug]??[]})})})]},t.siteSlug)}),M.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"px-4 py-6 text-center text-slate-500",colSpan:8,children:n?e.jsxs("div",{className:"p-4",children:[e.jsx(D,{columns:8}),e.jsx(D,{columns:8}),e.jsx(D,{columns:8})]}):"Nenhum resultado."})})]})]})})]}),F&&e.jsx("div",{className:y("fixed bottom-4 right-4 rounded-xl px-4 py-3 shadow-lg",F.type==="ok"?"bg-emerald-600 text-white":"bg-rose-600 text-white"),children:F.msg})]})}function B({title:n,value:i}){return e.jsxs("div",{className:"rounded-2xl bg-white shadow-sm p-5 border",children:[e.jsx("div",{className:"text-sm text-slate-500",children:n}),e.jsx("div",{className:"mt-1 text-3xl font-semibold",children:i})]})}function v({children:n,className:i=""}){return e.jsx("th",{className:y("px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide",i),children:n})}function N({children:n,className:i=""}){return e.jsx("td",{className:y("px-4 py-3 align-top",i),children:n})}function te({slug:n,email:i,billing:l,leads:h,feedbacks:x,traffic:p}){return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("section",{className:"rounded-xl border bg-white p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold",children:"Financeiro"}),e.jsx("button",{onClick:()=>l&&ee(`${n}-billing.csv`,[l]),className:"text-xs underline",disabled:!l,children:e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(C,{name:"download"})," CSV"]})})]}),l?l.ok?e.jsxs("ul",{className:"mt-3 space-y-1 text-sm",children:[e.jsxs("li",{children:[e.jsx("b",{children:"Plano:"})," ",l.plan]}),e.jsxs("li",{children:[e.jsx("b",{children:"Status:"})," ",l.status]}),e.jsxs("li",{children:[e.jsx("b",{children:"Próx. renovação:"})," ",O(l.next_renewal)]}),e.jsxs("li",{children:[e.jsx("b",{children:"Valor:"})," ",l.amount," ",l.currency]}),e.jsxs("li",{children:[e.jsx("b",{children:"Provedor:"})," ",l.provider]})]}):e.jsxs("div",{className:"text-sm text-rose-700 mt-2",children:["Erro ao carregar: ",l.error||"desconhecido"]}):e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"h-3 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded animate-pulse w-3/4"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded animate-pulse w-1/2"})]}),!!i&&e.jsxs("div",{className:"text-xs text-slate-500 mt-3",children:["E-mail: ",i]})]}),e.jsxs("section",{className:"rounded-xl border bg-white p-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h3",{className:"font-semibold",children:"Leads (últimos)"})}),e.jsxs("div",{className:"mt-2 space-y-2 max-h-60 overflow-auto pr-1",children:[(!h||h.length===0)&&e.jsx("div",{className:"text-sm text-slate-500",children:"Sem leads."}),h==null?void 0:h.slice(0,8).map((u,o)=>e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"font-medium",children:[u.name||"(sem nome)"," ",e.jsxs("span",{className:"text-slate-500",children:["· ",u.source||"-"]})]}),e.jsxs("div",{className:"text-slate-600",children:[u.email||"-"," · ",u.phone||"-"]}),e.jsx("div",{className:"text-xs text-slate-500",children:O(u.ts)})]},o))]})]}),e.jsxs("section",{className:"rounded-xl border bg-white p-4",children:[e.jsx("h3",{className:"font-semibold",children:"Configuração de Sessões (schema)"}),e.jsx(le,{slug:n})]}),e.jsxs("section",{className:"rounded-xl border bg-white p-4",children:[e.jsx("h3",{className:"font-semibold",children:"Controle de Funcionalidades"}),e.jsx(ne,{slug:n})]}),e.jsxs("section",{className:"rounded-xl border bg-white p-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h3",{className:"font-semibold",children:"Feedbacks"})}),e.jsxs("div",{className:"mt-2 space-y-2 max-h-40 overflow-auto pr-1",children:[(!x||x.length===0)&&e.jsx("div",{className:"text-sm text-slate-500",children:"Sem feedbacks."}),x==null?void 0:x.slice(0,6).map((u,o)=>e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"font-medium",children:[u.name||"(anônimo)"," · ⭐ ",u.rating]}),e.jsx("div",{className:"text-slate-700",children:u.comment||"-"}),e.jsx("div",{className:"text-xs text-slate-500",children:O(u.ts)})]},o))]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h4",{className:"font-semibold mb-1",children:"Tráfego (30d)"}),e.jsx(ae,{points:p})]})]})]})}function ae({points:n}){if(!(n!=null&&n.length))return e.jsx("div",{className:"text-sm text-slate-500",children:"Sem dados."});const i=Math.max(...n.map(l=>l.hits),1);return e.jsx("div",{className:"flex items-end gap-1 h-28",children:n.slice(-20).map(l=>e.jsx("div",{className:"flex-1 bg-slate-200 rounded-sm",title:`${l.day}: ${l.hits}`,children:e.jsx("div",{className:"bg-black w-full rounded-sm",style:{height:`${Math.max(6,l.hits/i*100)}%`}})},l.day))})}function ne({slug:n}){const[i,l]=m.useState(null),[h,x]=m.useState(!1),p=async()=>{x(!0);try{const c=await fetch("/.netlify/functions/admin-feature-control",{method:"POST",headers:{"Content-Type":"application/json","x-elevea-internal":k.ADMIN_DASH_TOKEN||k.ADMIN_TOKEN||""},body:JSON.stringify({action:"get_client_features",siteSlug:n})});if(c.ok){const g=await c.json();l(g)}}catch(c){console.error("Erro ao carregar features:",c)}finally{x(!1)}},u=async(c,g)=>{try{(await fetch("/.netlify/functions/admin-feature-control",{method:"POST",headers:{"Content-Type":"application/json","x-elevea-internal":k.ADMIN_DASH_TOKEN||k.ADMIN_TOKEN||""},body:JSON.stringify({action:"toggle_feature",siteSlug:n,featureId:c,enabled:g})})).ok&&p()}catch(S){console.error("Erro ao alterar feature:",S)}},o=async c=>{try{(await fetch("/.netlify/functions/admin-feature-control",{method:"POST",headers:{"Content-Type":"application/json","x-elevea-internal":k.ADMIN_DASH_TOKEN||k.ADMIN_TOKEN||""},body:JSON.stringify({action:"update_plan",siteSlug:n,plan:c})})).ok&&p()}catch(g){console.error("Erro ao alterar plano:",g)}};if(m.useEffect(()=>{p()},[n]),h||!i)return e.jsx("div",{className:"text-sm text-slate-500",children:"Carregando funcionalidades..."});const{settings:f,availableFeatures:T}=i,b=T.filter(c=>c.plan==="vip"&&!c.isCore);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("span",{className:"text-sm font-medium",children:"Plano atual:"}),e.jsxs("select",{value:f.plan,onChange:c=>o(c.target.value),className:"border rounded px-2 py-1 text-sm",children:[e.jsx("option",{value:"essential",children:"Essential"}),e.jsx("option",{value:"vip",children:"VIP"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"text-sm font-medium",children:"Funcionalidades VIP:"}),e.jsx("div",{className:"space-y-1",children:b.map(c=>{const g=f.enabledFeatures.includes(c.id);return e.jsxs("div",{className:"flex items-center justify-between py-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm",children:c.icon}),e.jsx("span",{className:"text-sm",children:c.name})]}),e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:g,onChange:S=>u(c.id,S.target.checked),className:"h-4 w-4",disabled:f.plan!=="vip"}),e.jsx("span",{className:"text-xs text-slate-500",children:g?"Ativo":"Inativo"})]})]},c.id)})})]}),f.plan!=="vip"&&e.jsx("div",{className:"text-xs text-amber-600 bg-amber-50 p-2 rounded",children:"⚠️ Cliente precisa do plano VIP para acessar funcionalidades avançadas"})]})}function le({slug:n}){const[i,l]=m.useState(!0),[h,x]=m.useState("");async function p(){var o,f;l(!0);try{const b=await(await fetch(`/.netlify/functions/client-api?action=get_settings&site=${encodeURIComponent(n)}&nc=${Date.now()}`,{cache:"no-store"})).json(),c=((f=(o=b==null?void 0:b.settings)==null?void 0:o.sections)==null?void 0:f.defs)||[];x(JSON.stringify(c,null,2))}catch{x("[]")}finally{l(!1)}}m.useEffect(()=>{p()},[n]);async function u(){try{const o=JSON.parse(h||"[]"),f=await fetch("/.netlify/functions/client-api",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"save_settings",site:n,settings:{sections:{defs:o}}})});if(!f.ok)throw new Error(`HTTP ${f.status}`);alert("Schema salvo com sucesso.")}catch(o){alert((o==null?void 0:o.message)||"Falha ao salvar schema.")}}return e.jsx("div",{className:"mt-2",children:i?e.jsx("div",{className:"text-sm text-slate-500",children:"Carregando…"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600 mb-2",children:["Edite o ",e.jsx("b",{children:"array"})," de sessões. Exemplo rápido:",e.jsx("pre",{className:"mt-2 bg-slate-50 border rounded p-2 overflow-auto",children:`[
  {
    "id": "hero",
    "name": "Sessão: Hero",
    "fields": [
      { "key": "title", "label": "Título" },
      { "key": "subtitle", "label": "Subtítulo" }
    ],
    "slots": [
      { "key": "hero_img_1", "label": "Foto 1" },
      { "key": "hero_img_2", "label": "Foto 2" }
    ]
  }
]`})]}),e.jsx("textarea",{className:"w-full h-56 border rounded p-2 font-mono text-xs",value:h,onChange:o=>x(o.target.value)}),e.jsxs("div",{className:"mt-2 flex gap-2",children:[e.jsx("button",{onClick:p,className:"border rounded px-3 py-1.5 text-sm",children:"Recarregar"}),e.jsx("button",{onClick:u,className:"bg-black text-white rounded px-3 py-1.5 text-sm",children:"Salvar schema"})]})]})})}export{ce as default};
//# sourceMappingURL=Dashboard-B_MgxnhE.js.map
