import{r as d,j as e,R as G}from"./index-BzNBZ-MS.js";const K="/.netlify/functions/sheets-proxy",W="/.netlify/functions/admin-toggle";function b(...n){return n.filter(Boolean).join(" ")}function X({children:n,tone:r="neutral"}){const l={neutral:"bg-gray-100 text-gray-700 border border-gray-200",green:"bg-emerald-100 text-emerald-700 border border-emerald-200",red:"bg-rose-100 text-rose-700 border border-rose-200",amber:"bg-amber-100 text-amber-800 border border-amber-200"};return e.jsxs("span",{className:b("px-2.5 py-1 rounded-full text-xs font-medium inline-flex items-center gap-1",l[r]),children:[e.jsx("span",{className:"h-1.5 w-1.5 rounded-full bg-current opacity-80"}),n]})}function S(n){const{className:r,variant:l="solid",...h}=n,x="inline-flex items-center justify-center rounded-xl text-sm px-3.5 py-2.5 transition shadow-sm disabled:opacity-60 disabled:cursor-not-allowed",f={solid:"bg-black text-white hover:bg-gray-900",outline:"border border-gray-300 bg-white hover:bg-gray-50",ghost:"hover:bg-gray-100 text-gray-800"};return e.jsx("button",{className:b(x,f[l],r),...h})}function w({name:n,className:r=""}){const l={refresh:"M4 4v4m0-4h4M4 8l4-4m8 12v-4m0 4h-4m4-4-4 4M4 16h4m8-8h4",lock:"M6 10V8a4 4 0 1 1 8 0v2m-9 0h10v6a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-6z",unlock:"M15 10V8a4 4 0 0 0-8 0m-1 2h10v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-6z",download:"M12 3v10m0 0 3-3m-3 3-3-3M5 17h14",search:"M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16zm11 3-6-6"};return e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.8",className:b("h-4 w-4",r),children:e.jsx("path",{d:l[n],strokeLinecap:"round",strokeLinejoin:"round"})})}function T(n){if(!n)return"—";try{return new Date(n).toLocaleString("pt-BR")}catch{return String(n)}}function Y(n,r){if(!r||!r.length)return;const l=Object.keys(r[0]),h=[l.join(","),...r.map(o=>l.map(j=>JSON.stringify(o[j]??"")).join(","))].join(`
`),x=new Blob([h],{type:"text/csv;charset=utf-8;"}),f=URL.createObjectURL(x),m=document.createElement("a");m.href=f,m.download=n,m.click(),URL.revokeObjectURL(f)}function Z(n,r=250){const[l,h]=d.useState(n);return d.useEffect(()=>{const x=setTimeout(()=>h(n),r);return()=>clearTimeout(x)},[n,r]),l}function ne(){const[n,r]=d.useState(!1),[l,h]=d.useState([]),[x,f]=d.useState(""),m=Z(x,250),[o,j]=d.useState("all"),[B,N]=d.useState(""),[y,M]=d.useState(""),[O,q]=d.useState({}),[A,I]=d.useState({}),[z,H]=d.useState({}),[J,V]=d.useState({}),[P,_]=d.useState(""),[$,F]=d.useState(null);function E(s,t){F({type:s,msg:t}),setTimeout(()=>F(null),3200)}async function R(){r(!0),N("");try{const s=await fetch(`/.netlify/functions/admin-sites?nc=${Date.now()}`,{cache:"no-store"});if(!s.ok)throw new Error(`Falha ao listar sites (HTTP ${s.status})`);const t=await s.json(),a=((t==null?void 0:t.siteSlugs)||[]).filter(Boolean),c=await Promise.all(a.map(async i=>{try{const u=await fetch(`${K}?type=status&site=${encodeURIComponent(i)}&nc=${Date.now()}`,{cache:"no-store"});if(!u.ok)throw new Error(`Falha status ${i} (HTTP ${u.status})`);const v=await u.json();return{siteSlug:i,status:v}}catch(u){return console.error(u),{siteSlug:i,status:null}}}));h(c)}catch(s){N((s==null?void 0:s.message)||"Erro ao carregar dados."),h([])}finally{r(!1)}}d.useEffect(()=>{R()},[]);const D=d.useMemo(()=>{const s=m.trim().toUpperCase();return l.filter(t=>{const a=t.status,c=!s||t.siteSlug.toUpperCase().includes(s)||((a==null?void 0:a.email)||"").toUpperCase().includes(s)||((a==null?void 0:a.preapproval_id)||"").toUpperCase().includes(s);let i=!0;return o==="active"&&(i=!!(a!=null&&a.ok&&(a!=null&&a.active)&&!(a!=null&&a.manualBlock))),o==="blocked"&&(i=!!(a!=null&&a.manualBlock)),o==="inactive"&&(i=!!(a!=null&&a.ok&&!(a!=null&&a.active))),c&&i})},[l,m,o]),k=d.useMemo(()=>{const s=l.length,t=l.filter(i=>{var u,v,L;return((u=i.status)==null?void 0:u.ok)&&((v=i.status)==null?void 0:v.active)&&!((L=i.status)!=null&&L.manualBlock)}).length,a=l.filter(i=>{var u;return(u=i.status)==null?void 0:u.manualBlock}).length,c=l.filter(i=>{var u,v;return((u=i.status)==null?void 0:u.ok)&&!((v=i.status)!=null&&v.active)}).length;return{total:s,active:t,blocked:a,inactive:c}},[l]);async function U(s,t){try{_(s);const a=await fetch(W,{method:"POST",headers:{"Content-Type":"application/json","x-elevea-internal":"1"},body:JSON.stringify({action:"manual-block",siteSlug:s,block:!!t})});if(!a.ok){const c=await a.text().catch(()=>"");throw new Error(`HTTP ${a.status} - ${c||"admin-toggle falhou"}`)}E("ok",t?"Site bloqueado":"Site reativado"),await R()}catch(a){console.error(a),E("err",(a==null?void 0:a.message)||"Falha ao alternar bloqueio."),alert((a==null?void 0:a.message)||"Falha ao alternar bloqueio.")}finally{_("")}}async function Q(s,t){if(M(a=>a===s?"":s),!(y&&y===s))try{if(t){const c=await(await fetch(`/.netlify/functions/client-billing?email=${encodeURIComponent(t)}`,{cache:"no-store"})).json();q(i=>({...i,[s]:c}))}{const c=await(await fetch(`/.netlify/functions/client-api?action=list_leads&site=${encodeURIComponent(s)}&page=1&size=100&nc=${Date.now()}`,{cache:"no-store"})).json();I(i=>({...i,[s]:(c==null?void 0:c.items)||[]}))}{const c=await(await fetch(`/.netlify/functions/client-api?action=list_feedbacks&site=${encodeURIComponent(s)}&page=1&size=100&nc=${Date.now()}`,{cache:"no-store"})).json();H(i=>({...i,[s]:(c==null?void 0:c.items)||[]}))}{const c=await(await fetch(`/.netlify/functions/client-api?action=get_traffic&site=${encodeURIComponent(s)}&range=30d&nc=${Date.now()}`,{cache:"no-store"})).json();V(i=>({...i,[s]:(c==null?void 0:c.daily)||[]}))}}catch(a){console.error(a),E("err","Alguns relatórios não puderam ser carregados.")}}return e.jsxs("div",{className:"min-h-screen bg-gradient-to-b from-slate-50 to-slate-100/60 py-10 px-5 md:px-8",children:[e.jsxs("div",{className:"mx-auto max-w-7xl space-y-8",children:[e.jsxs("div",{className:"flex flex-col gap-4 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-semibold tracking-tight",children:"Painel Elevea · Assinaturas"}),e.jsx("p",{className:"text-slate-600 mt-1",children:"Status, bloqueios e relatórios (financeiro, leads, feedbacks, tráfego)."})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(S,{variant:"outline",onClick:R,disabled:n,children:[e.jsx(w,{name:"refresh",className:b(n&&"animate-spin")})," ",e.jsx("span",{className:"ml-2",children:n?"Atualizando":"Atualizar"})]})})]}),!!B&&e.jsxs("div",{className:"rounded-xl border bg-white p-3 text-sm text-rose-700",children:[e.jsx("div",{className:"font-medium",children:"Erro"}),e.jsx("div",{className:"opacity-80",children:B})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(C,{title:"Total",value:k.total}),e.jsx(C,{title:"Ativos",value:k.active}),e.jsx(C,{title:"Bloqueados",value:k.blocked}),e.jsx(C,{title:"Inativos",value:k.inactive})]}),e.jsxs("div",{className:"flex flex-col md:flex-row items-stretch md:items-center gap-3",children:[e.jsxs("div",{className:"relative w-full md:w-[28rem]",children:[e.jsx(w,{name:"search",className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"}),e.jsx("input",{className:"w-full border rounded-xl pl-9 pr-3 py-2.5 bg-white focus:outline-none focus:ring-2 focus:ring-black/70",placeholder:"Buscar por site, e-mail ou preapproval_id...",value:x,onChange:s=>f(s.target.value)})]}),e.jsx("div",{className:"flex gap-2",children:["all","active","blocked","inactive"].map(s=>e.jsx(S,{variant:o===s?"solid":"outline",onClick:()=>j(s),children:s},s))})]}),e.jsx("div",{className:"overflow-x-auto rounded-2xl border bg-white shadow-sm",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-slate-50 text-slate-600 sticky top-0",children:e.jsxs("tr",{children:[e.jsx(p,{children:"Site"}),e.jsx(p,{children:"Status"}),e.jsx(p,{children:"Pagamento"}),e.jsx(p,{children:"E-mail"}),e.jsx(p,{children:"Preapproval"}),e.jsx(p,{children:"Atualizado"}),e.jsx(p,{className:"text-center",children:"Bloq. manual"}),e.jsx(p,{className:"text-right",children:"Ações"})]})}),e.jsxs("tbody",{children:[D.map(s=>{const t=s.status,a=t!=null&&t.ok?t!=null&&t.manualBlock?"red":t!=null&&t.active?"green":"neutral":"amber",c=t!=null&&t.ok?t!=null&&t.manualBlock?"bloqueado":t!=null&&t.active?"ativo":"inativo":"erro";return e.jsxs(G.Fragment,{children:[e.jsxs("tr",{className:"border-t hover:bg-slate-50/70",children:[e.jsx(g,{className:"font-medium",children:s.siteSlug}),e.jsx(g,{children:e.jsx(X,{tone:a,children:c})}),e.jsx(g,{children:(t==null?void 0:t.status)||"—"}),e.jsx(g,{className:"max-w-[16rem] truncate",children:(t==null?void 0:t.email)||"—"}),e.jsx(g,{className:"max-w-[12rem] truncate",children:(t==null?void 0:t.preapproval_id)||"—"}),e.jsx(g,{children:T(t==null?void 0:t.updatedAt)}),e.jsx(g,{className:"text-center",children:e.jsx("input",{type:"checkbox",className:"h-4 w-4 accent-black",checked:!!(t!=null&&t.manualBlock),onChange:i=>U(s.siteSlug,i.target.checked),disabled:P===s.siteSlug,"aria-label":`Bloqueio manual de ${s.siteSlug}`})}),e.jsxs(g,{className:"text-right space-x-2 whitespace-nowrap",children:[e.jsx(S,{variant:"outline",onClick:()=>Q(s.siteSlug,t==null?void 0:t.email),children:"Relatórios"}),e.jsx(S,{onClick:()=>U(s.siteSlug,!(t!=null&&t.manualBlock)),disabled:P===s.siteSlug,className:b(t!=null&&t.manualBlock?"bg-emerald-600 hover:bg-emerald-700":"bg-black hover:bg-gray-900","text-white"),children:t!=null&&t.manualBlock?e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx(w,{name:"unlock"})," Reativar"]}):e.jsxs("span",{className:"inline-flex items-center gap-2",children:[e.jsx(w,{name:"lock"})," Bloquear"]})})]})]}),y===s.siteSlug&&e.jsx("tr",{className:"bg-slate-50/60",children:e.jsx("td",{colSpan:8,className:"px-4 py-6",children:e.jsx(ee,{slug:s.siteSlug,email:t==null?void 0:t.email,billing:O[s.siteSlug]??null,leads:A[s.siteSlug]??[],feedbacks:z[s.siteSlug]??[],traffic:J[s.siteSlug]??[]})})})]},s.siteSlug)}),D.length===0&&e.jsx("tr",{children:e.jsx("td",{className:"px-4 py-6 text-center text-slate-500",colSpan:8,children:n?"Carregando...":"Nenhum resultado."})})]})]})})]}),$&&e.jsx("div",{className:b("fixed bottom-4 right-4 rounded-xl px-4 py-3 shadow-lg",$.type==="ok"?"bg-emerald-600 text-white":"bg-rose-600 text-white"),children:$.msg})]})}function C({title:n,value:r}){return e.jsxs("div",{className:"rounded-2xl bg-white shadow-sm p-5 border",children:[e.jsx("div",{className:"text-sm text-slate-500",children:n}),e.jsx("div",{className:"mt-1 text-3xl font-semibold",children:r})]})}function p({children:n,className:r=""}){return e.jsx("th",{className:b("px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide",r),children:n})}function g({children:n,className:r=""}){return e.jsx("td",{className:b("px-4 py-3 align-top",r),children:n})}function ee({slug:n,email:r,billing:l,leads:h,feedbacks:x,traffic:f}){return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("section",{className:"rounded-xl border bg-white p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold",children:"Financeiro"}),e.jsx("button",{onClick:()=>l&&Y(`${n}-billing.csv`,[l]),className:"text-xs underline",disabled:!l,children:e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(w,{name:"download"})," CSV"]})})]}),l?l.ok?e.jsxs("ul",{className:"mt-3 space-y-1 text-sm",children:[e.jsxs("li",{children:[e.jsx("b",{children:"Plano:"})," ",l.plan]}),e.jsxs("li",{children:[e.jsx("b",{children:"Status:"})," ",l.status]}),e.jsxs("li",{children:[e.jsx("b",{children:"Próx. renovação:"})," ",T(l.next_renewal)]}),e.jsxs("li",{children:[e.jsx("b",{children:"Valor:"})," ",l.amount," ",l.currency]}),e.jsxs("li",{children:[e.jsx("b",{children:"Provedor:"})," ",l.provider]})]}):e.jsxs("div",{className:"text-sm text-rose-700 mt-2",children:["Erro ao carregar: ",l.error||"desconhecido"]}):e.jsx("div",{className:"text-sm text-slate-500 mt-2",children:"Carregando..."}),!!r&&e.jsxs("div",{className:"text-xs text-slate-500 mt-3",children:["E-mail: ",r]})]}),e.jsxs("section",{className:"rounded-xl border bg-white p-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h3",{className:"font-semibold",children:"Leads (últimos)"})}),e.jsxs("div",{className:"mt-2 space-y-2 max-h-60 overflow-auto pr-1",children:[(!h||h.length===0)&&e.jsx("div",{className:"text-sm text-slate-500",children:"Sem leads."}),h==null?void 0:h.slice(0,8).map((m,o)=>e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"font-medium",children:[m.name||"(sem nome)"," ",e.jsxs("span",{className:"text-slate-500",children:["· ",m.source||"-"]})]}),e.jsxs("div",{className:"text-slate-600",children:[m.email||"-"," · ",m.phone||"-"]}),e.jsx("div",{className:"text-xs text-slate-500",children:T(m.ts)})]},o))]})]}),e.jsxs("section",{className:"rounded-xl border bg-white p-4",children:[e.jsx("h3",{className:"font-semibold",children:"Configuração de Sessões (schema)"}),e.jsx(se,{slug:n})]}),e.jsxs("section",{className:"rounded-xl border bg-white p-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h3",{className:"font-semibold",children:"Feedbacks"})}),e.jsxs("div",{className:"mt-2 space-y-2 max-h-40 overflow-auto pr-1",children:[(!x||x.length===0)&&e.jsx("div",{className:"text-sm text-slate-500",children:"Sem feedbacks."}),x==null?void 0:x.slice(0,6).map((m,o)=>e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"font-medium",children:[m.name||"(anônimo)"," · ⭐ ",m.rating]}),e.jsx("div",{className:"text-slate-700",children:m.comment||"-"}),e.jsx("div",{className:"text-xs text-slate-500",children:T(m.ts)})]},o))]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h4",{className:"font-semibold mb-1",children:"Tráfego (30d)"}),e.jsx(te,{points:f})]})]})]})}function te({points:n}){if(!(n!=null&&n.length))return e.jsx("div",{className:"text-sm text-slate-500",children:"Sem dados."});const r=Math.max(...n.map(l=>l.hits),1);return e.jsx("div",{className:"flex items-end gap-1 h-28",children:n.slice(-20).map(l=>e.jsx("div",{className:"flex-1 bg-slate-200 rounded-sm",title:`${l.day}: ${l.hits}`,children:e.jsx("div",{className:"bg-black w-full rounded-sm",style:{height:`${Math.max(6,l.hits/r*100)}%`}})},l.day))})}function se({slug:n}){const[r,l]=d.useState(!0),[h,x]=d.useState("");async function f(){var o,j;l(!0);try{const N=await(await fetch(`/.netlify/functions/client-api?action=get_settings&site=${encodeURIComponent(n)}&nc=${Date.now()}`,{cache:"no-store"})).json(),y=((j=(o=N==null?void 0:N.settings)==null?void 0:o.sections)==null?void 0:j.defs)||[];x(JSON.stringify(y,null,2))}catch{x("[]")}finally{l(!1)}}d.useEffect(()=>{f()},[n]);async function m(){try{const o=JSON.parse(h||"[]"),j=await fetch("/.netlify/functions/client-api",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"save_settings",site:n,settings:{sections:{defs:o}}})});if(!j.ok)throw new Error(`HTTP ${j.status}`);alert("Schema salvo com sucesso.")}catch(o){alert((o==null?void 0:o.message)||"Falha ao salvar schema.")}}return e.jsx("div",{className:"mt-2",children:r?e.jsx("div",{className:"text-sm text-slate-500",children:"Carregando…"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-slate-600 mb-2",children:["Edite o ",e.jsx("b",{children:"array"})," de sessões. Exemplo rápido:",e.jsx("pre",{className:"mt-2 bg-slate-50 border rounded p-2 overflow-auto",children:`[
  {
    "id": "hero",
    "name": "Sessão: Hero",
    "fields": [
      { "key": "title", "label": "Título" },
      { "key": "subtitle", "label": "Subtítulo" }
    ],
    "slots": [
      { "key": "hero_img_1", "label": "Foto 1" },
      { "key": "hero_img_2", "label": "Foto 2" }
    ]
  }
]`})]}),e.jsx("textarea",{className:"w-full h-56 border rounded p-2 font-mono text-xs",value:h,onChange:o=>x(o.target.value)}),e.jsxs("div",{className:"mt-2 flex gap-2",children:[e.jsx("button",{onClick:f,className:"border rounded px-3 py-1.5 text-sm",children:"Recarregar"}),e.jsx("button",{onClick:m,className:"bg-black text-white rounded px-3 py-1.5 text-sm",children:"Salvar schema"})]})]})})}export{ne as default};
